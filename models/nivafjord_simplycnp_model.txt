

model("NIVAFjord-SimplyCNP") {
	
	extend("nivafjord_chem_base.txt") @exclude(air : compartment)
	
	extend("simplycnp_model.txt") @exclude(
		downstream : connection, 
		air : compartment, 
		water : quantity,
		heat : quantity,
		sed : quantity,
		oc : quantity,
		din : quantity,
		on : quantity,
		phos : quantity,
		op : quantity,
		temp : property,
		precip : property,
		tn : property,
		tp : property,
		wind : property,
		g_rad : property,
		pressure : property,
		a_hum : property,
		lwd : property,
		cos_z : property,
		a_vap : property,
		s_vap : property,
		rho : property,
		sol : solver,
		gw_st : connection,
	)
	
	air        : compartment("Atmosphere", wb_index)
	
	edge       : compartment("Basin edge",       basin_idx, e_idx)
	edge_layer : compartment("Basin edge layer", basin_idx, e_idx, layer_idx)
	
	load("modules/nivafjord/horizontal_fluxes.txt",
		module("NIVAFjord horizontal fluxes", basin, bnd_basin, layer, bnd_layer, edge, edge_layer, water, salt, temp, salinity, rho, pressure, dz, h, horz, vert, dims),
		module("NIVAFjord river inputs", river, layer, water, salt, temp, salinity, rho, flow, horz, vert),
		module("NIVAFjord simple realignment", basin, layer, water, dz, vert, dims)
	)
	
	load("modules/easylake/easychem.txt",
		module("Simple River Oâ‚‚", river, water, o2, temp))
	
	wb_index : index_set("Water body") @union(sc, basin_idx)
	
	downstream : connection("Downstream") @directed_graph {
		river+
	} @no_cycles
	
	horz : connection("Fjord horizontal") @directed_graph(e_idx) { 
		(river? layer+ bnd_layer?) | river
	} @no_cycles
	
	option(gw_module.karstic) {
		
		# Allow connecting subterranean groundwater flow directly to ocean/lake basins.
		gw_st : connection("Groundwater subterranean") @directed_graph {
			gw+ layer
		} @no_cycles
		
		unit_conversion(gw.water, layer.water) { a_catch->> }
		
		# TODO: Maybe factor out
		# Needed since we have direct discharge from gw to lake
		module("Groundwater temp and O2", version(0,0,0)) {
			
			load("stdlib/physiochemistry.txt", library("Water utils"))
			
			var(gw.water.heat, [J, k m-2], "Groundwater heat") @override {
				t := aggregate(soil.temp),
				V := 1[k m 2]*gw.water -> [m 3],
				(water_temp_to_heat(V, t) / 1[k m 2]) ->>
			}
			
			var(gw.water.o2, [k g, k m-2], "Groundwater oxygen") @override_conc {
				conc(river.water.o2) # TODO: do something else here?
			}
		}
		
	}
}

