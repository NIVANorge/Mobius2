

model("EasyLake-SimplyQ multibasin") {
	
	extend("simplyq_model.txt")
	
	#epi      : compartment("Epilimnion")
	hyp      : compartment("Hypolimnion")
	
	ice      : quantity("Ice")
	
	wind     : property("Wind speed")
	g_rad    : property("Global radiation")
	pressure : property("Pressure")
	a_hum    : property("Actual specific humidity")
	rho      : property("Density")
	lwd      : property("Downwelling longwave radiation")
	sw       : property("Shortwave radiation")
	attn     : property("Attenuation coefficient")
	z_e      : property("Thickness")
	
	heat : quantity("Heat energy")
	
	evap_mm  : property("Evaporation per area")
	
	par_group("Lake data", epi) {
		A_surf : par_real("Lake surface area", [m 2], 107183, 0, 371e9)
	}
	
	load("modules/simplysoiltemp.txt", module("Simply soil temperature", air, soil, snow_box, snow, temp))
	load("modules/rivertemp.txt",      module("RiverTemperature", air, soil, river, water, heat, temp))
	load("modules/atmospheric.txt",    module("Atmospheric", air, temp, wind, g_rad, pressure, a_hum, rho, lwd))
	load("modules/airsea.txt",         module("AirSea", "AirSea Lake", air, epi, ice, evap_mm, temp, precip, wind, g_rad, pressure, rho, a_hum, lwd, sw, attn,
											loc(A_surf), ht : loc(epi.water.heat), ht, loc(epi.water.temp)))
	load("modules/easylake.txt",       module("EasyLake", air, epi, hyp, water, ice, heat, temp, precip, z_e, evap_mm, A_surf, loc(downstream)))
	
	solve(simply_solver, epi.water, hyp.water, epi.ice)
	
	lake_index : index_set("Lake")
	
	distribute(epi, lake_index)
	distribute(hyp, lake_index)
	
	horz : connection("Horizontal", all_to_all) { epi* }
	horz_hyp : connection("Horizontal hypo", all_to_all) { hyp* }
	
	module("Horizontal mixing", version(0, 0, 1)) {
		
		par_group("Horizontal mixing", epi) {
			mix : par_real("Horizontal mixing coefficient", [day-1], 0.1)
		}
		
		flux(epi.water, horz, [m 3, day-1], "Epi horizontal mixing") {
			(water + water[below]) * mix
		}
		
		flux(hyp.water, horz_hyp, [m 3, day-1], "Hyp horizontal mixing") {
			(water + water[below]) * mix
		}
	}
	
	# NOTE: Just update the regex for the compartments.
	# override(downstream) { (river|epi)* }
}